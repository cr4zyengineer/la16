/*
 * MIT License
 *
 * Copyright (c) 2024 cr4zyengineer
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

const vp_umapped    0b0
const vp_maooed     0b1
const vp_mapped_rw  0b0111
const vp_mapped_rx  0b1011
const vp_mapped_ro  0b0011

section .data
    kernel_hello db "[*] hello from kernel\n\0"
    kernel_user_stack db "[*] allocated stack pages for user\n[*] mapped pages for user and kernel\n[*] jumping into userspace entry at: 0x\0"
    kernel_user_stack_fail db "[!] failed to allocate stack pages for user\n\0"

_start:
    call _int_init                                      ; initilizing interupt handler
    call _puts, kernel_hello                            ; saying hello to this burning world
    call _pmm_init                                      ; initilizing physical page memory management
    mov r0, 0x00                                        ; Setting up r0 for rx virtual map loop, so the user program can access our pages (for testing)
.rx_map_loop:
    call _map_page_with_prot, r0, r0, vp_mapped_rx      ; memory mapping setup FIXME: r0 overrides custom set r1
    cmp r0, ppt_kpages                                  ; only mapping till reaching ppt_kpages
    inc r0
    jlt .rx_map_loop
.userstack_fixup:
    mov r0, 0x100
.userstack_fixup_loop:
    call _alloc_user_stack_page, r0
    cmp r0, 0xFE
    dec r0
    jgt .userstack_fixup_loop
.print_your_bullshit:
    call _puts, kernel_user_stack                       ; saying what the hell this crap does
    call _putbase, _userspace_entry, 16                 ; saying destination
    call _putc, '\n'                                    ; returning
    mov sp, 0xFFFE                                      ; fixing up stack for user program
    mov el, 0b0                                         ; switching to user level                   
    bl _userspace_entry                                 ; Jumping to userspace entry
.end:
    hlt                                                 ; da end of the road

_alloc_user_stack_page:
    call _pmm_page_alloc
    cmp rr, ppt_error_no_free_page
    je .panic_no_user_page
    mov r10, r0
    call _map_page_with_prot, rr, r10, vp_mapped_rw
    ret
.panic_no_user_page:
    call _puts, kernel_user_stack_fail
    hlt

_map_page_with_prot:
    vpset r1, r0                                        ; setting physical page to virtual page
    vpflgset r1, r2                                     ; setting flags of virtual page
    ret